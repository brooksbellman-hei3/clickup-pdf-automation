<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Dashboard - Hawkeye Innovations</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .dashboard-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 600;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .chart-container:hover {
            transform: translateY(-3px);
        }

        .chart-title {
            font-size: 1.1rem;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }

        .chart-image {
            width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .chart-image svg {
            width: 100%;
            height: auto;
            border-radius: 8px;
        }

        .date-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .date-input {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            color: #333;
            transition: border-color 0.3s ease;
        }

        .date-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
            transform: translateY(-2px);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .success {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .row-counter {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .counter-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 20px 30px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            min-width: 150px;
        }

        .counter-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .counter-label {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.9;
        }

        .last-night-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }

        .last-night-section h3 {
            color: #2c3e50;
            font-size: 1.3rem;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .date-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÄ Overall Season Review</h1>
            <p>Hawkeye Innovations - NBA Operations Analytics</p>
            
            <!-- Season Overview Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalGames">-</div>
                    <div class="stat-label">Total # of Games</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="liveTrackingDelivery">-</div>
                    <div class="stat-label">Live Tracking Delivery %</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="replayDelivery">-</div>
                    <div class="stat-label">Replay Delivery %</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="slaHitPercentage">-</div>
                    <div class="stat-label">SLA Hit %</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="resendPercentage">-</div>
                    <div class="stat-label">Resend %</div>
                </div>
            </div>
            
            <!-- Last Night's Performance -->
            <div class="last-night-section">
                <h3>üìÖ Last Night's Performance</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="lastNightGames">-</div>
                        <div class="stat-label"># of Games</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="lastNightSLAsHit">-</div>
                        <div class="stat-label"># of SLAs Hit</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="lastNightSLAsMissed">-</div>
                        <div class="stat-label"># of SLAs Missed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="lastNightResends">-</div>
                        <div class="stat-label"># of Resends</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-section">
            <h2 class="section-title">üìä All-Time Metrics</h2>
            <div class="row-counter">
                <div class="counter-card">
                    <div class="counter-number" id="totalGames">-</div>
                    <div class="counter-label">Total Games</div>
                </div>
            </div>
            <div class="charts-grid" id="allTimeCharts">
                <div class="loading">Loading all-time charts...</div>
            </div>
        </div>

        <div class="dashboard-section">
            <h2 class="section-title">üìÖ Specific Date Metrics</h2>
            <div class="date-controls">
                <input type="date" id="specificDate" class="date-input" placeholder="Select Date">
                <button onclick="loadSpecificDateCharts()" class="btn btn-primary">Load Specific Date</button>
                <button onclick="setTodayDate()" class="btn btn-secondary">Today</button>
                <button onclick="sendDashboardEmail()" class="btn btn-primary" style="background: #28a745;">üìß Send Dashboard Email</button>
            </div>
            <div class="row-counter">
                <div class="counter-card">
                    <div class="counter-number" id="lastNightsGames">-</div>
                    <div class="counter-label">Last Night's Games</div>
                </div>
            </div>
            <div class="charts-grid" id="specificDateCharts">
                <div class="loading">Select a specific date to view charts...</div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>Powered by Hawkeye Innovations | Executive Dashboard v2.0</p>
    </div>

    <script>
        // Set yesterday's date as default
        function setYesterdayDate() {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            document.getElementById('specificDate').value = yesterday.toISOString().split('T')[0];
            loadSpecificDateCharts();
        }

        // Set today's date
        function setTodayDate() {
            const today = new Date();
            document.getElementById('specificDate').value = today.toISOString().split('T')[0];
            loadSpecificDateCharts();
        }

        // Initialize with yesterday's date
        window.onload = function() {
            setYesterdayDate();
        };

        // Load charts for specific date (Row 2)
        async function loadSpecificDateCharts() {
            const specificDate = document.getElementById('specificDate').value;
            
            if (!specificDate) {
                alert('Please select a specific date');
                return;
            }
            
            const container = document.getElementById('specificDateCharts');
            container.innerHTML = '<div class="loading">Loading specific date charts...</div>';
            
            try {
                const response = await fetch(`/api/dashboard/complete?specificDate=${specificDate}`);
                
                if (!response.ok) {
                    throw new Error('Failed to load specific date charts');
                }
                
                const data = await response.json();
                // Show all charts (both rows)
                const allCharts = data.charts;
                // For specific date, we want to show both rows, but the first row is all-time
                // and the second row is specific date. We'll show all charts.
                displayCharts(container, allCharts, data.stats, data.numberCardStats);
                
                // Update last night's games counter
                updateRowCounters(null, data.stats.lastNightGames);
                
            } catch (error) {
                container.innerHTML = `<div class="error">Error loading charts: ${error.message}</div>`;
            }
        }

        // Send dashboard email
        async function sendDashboardEmail() {
            const specificDate = document.getElementById('specificDate').value;
            
            try {
                let response;
                if (specificDate) {
                    // Send email with specific date
                    response = await fetch(`/send-dashboard-email/${specificDate}`);
                } else {
                    // Send general dashboard email
                    response = await fetch('/send-dashboard-email');
                }
                
                if (!response.ok) {
                    throw new Error('Failed to send dashboard email');
                }
                
                const data = await response.json();
                alert('‚úÖ Dashboard email sent successfully! Check your inbox.');
                
            } catch (error) {
                alert(`‚ùå Error sending dashboard email: ${error.message}`);
            }
        }

        // Display charts in container
        function displayCharts(container, charts, stats, numberCardStats) {
            if (!charts || charts.length === 0) {
                container.innerHTML = '<div class="error">No data available for the selected date range</div>';
                return;
            }
            
            container.innerHTML = charts.map(chart => {
                // Check if it's an SVG chart
                if (chart.svg) {
                    return `
                        <div class="chart-container">
                            <div class="chart-title">${chart.title}</div>
                            <div class="chart-image">${chart.svg}</div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="chart-container">
                            <div class="chart-title">${chart.title}</div>
                            <img src="data:image/png;base64,${chart.base64Chart}" alt="${chart.title}" class="chart-image">
                        </div>
                    `;
                }
            }).join('');
            
            // Update stats if provided
            if (stats) {
                updateStats(stats, numberCardStats);
            }
        }

        // Update dashboard statistics
        function updateStats(stats, numberCardStats) {
            // Season overview stats
            if (stats.totalGames !== undefined) {
                document.getElementById('totalGames').textContent = stats.totalGames;
            }
            if (stats.liveTrackingDelivery !== undefined) {
                document.getElementById('liveTrackingDelivery').textContent = stats.liveTrackingDelivery + '%';
            }
            if (stats.replayDelivery !== undefined) {
                document.getElementById('replayDelivery').textContent = stats.replayDelivery + '%';
            }
            if (stats.slaHitPercentage !== undefined) {
                document.getElementById('slaHitPercentage').textContent = stats.slaHitPercentage + '%';
            }
            if (stats.resendPercentage !== undefined) {
                document.getElementById('resendPercentage').textContent = stats.resendPercentage + '%';
            }
            
            // Last night's stats
            if (stats.lastNightGames !== undefined) {
                document.getElementById('lastNightGames').textContent = stats.lastNightGames;
            }
            if (stats.lastNightSLAsHit !== undefined) {
                document.getElementById('lastNightSLAsHit').textContent = stats.lastNightSLAsHit;
            }
            if (stats.lastNightSLAsMissed !== undefined) {
                document.getElementById('lastNightSLAsMissed').textContent = stats.lastNightSLAsMissed;
            }
            if (stats.lastNightResends !== undefined) {
                document.getElementById('lastNightResends').textContent = stats.lastNightResends;
            }
            
            // Update number card stats if provided
            if (numberCardStats) {
                updateNumberCardStats(numberCardStats);
            }
        }
        
        // Update number card statistics
        function updateNumberCardStats(numberCardStats) {
            console.log('Updating number card stats:', numberCardStats);
            
            // Update NBA SLA Delivery Time stats
            if (numberCardStats['NBA SLA Delivery Time']) {
                const slaStats = numberCardStats['NBA SLA Delivery Time'];
                const hitSLA = slaStats['Hit SLA'] || 0;
                const totalSLA = Object.values(slaStats).reduce((sum, count) => sum + count, 0);
                const hitPercentage = totalSLA > 0 ? Math.round((hitSLA / totalSLA) * 100) : 0;
                
                // Update the SLA stat in the header
                const slaElement = document.getElementById('slaHitPercentage');
                if (slaElement) {
                    slaElement.textContent = hitPercentage + '%';
                }
            }
            
            // Update Scrub SLA stats
            if (numberCardStats['Scrub SLA ']) {
                const scrubStats = numberCardStats['Scrub SLA '];
                const yesScrub = scrubStats['NBA | Yes | < 30 Mins Post Game'] || 0;
                const totalScrub = Object.values(scrubStats).reduce((sum, count) => sum + count, 0);
                const scrubPercentage = totalScrub > 0 ? Math.round((yesScrub / totalScrub) * 100) : 0;
                
                // Add a new stat for Scrub SLA if needed
                console.log(`Scrub SLA: ${scrubPercentage}% (${yesScrub}/${totalScrub})`);
            }
            
            // Update Resend stats
            if (numberCardStats['Resend']) {
                const resendStats = numberCardStats['Resend'];
                const yesResend = resendStats['Yes'] || 0;
                const totalResend = Object.values(resendStats).reduce((sum, count) => sum + count, 0);
                const resendPercentage = totalResend > 0 ? Math.round((yesResend / totalResend) * 100) : 0;
                
                // Update the resend stat in the header
                const resendElement = document.getElementById('resendPercentage');
                if (resendElement) {
                    resendElement.textContent = resendPercentage + '%';
                }
            }
        }

        // Update row counters
        function updateRowCounters(totalGames, lastNightsGames = null) {
            // Update total games counter
            if (totalGames !== undefined) {
                document.getElementById('totalGames').textContent = totalGames;
            }
            
            // Update last night's games counter
            if (lastNightsGames !== undefined && lastNightsGames !== null) {
                document.getElementById('lastNightsGames').textContent = lastNightsGames;
            }
        }

        // Load all-time charts on page load
        async function loadAllTimeCharts() {
            const container = document.getElementById('allTimeCharts');
            
            try {
                const response = await fetch('/api/dashboard/all-time');
                
                if (!response.ok) {
                    throw new Error('Failed to load all-time charts');
                }
                
                const data = await response.json();
                displayCharts(container, data.charts, data.stats, data.numberCardStats);
                
                // Update total games counter
                updateRowCounters(data.stats.totalGames);
                
            } catch (error) {
                container.innerHTML = `<div class="error">Error loading charts: ${error.message}</div>`;
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadAllTimeCharts();
            setYesterdayDate(); // Set yesterday's date as default
        });
    </script>
</body>
</html>
